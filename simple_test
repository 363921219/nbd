#!/bin/sh
# Yes, that's POSIX sh, not bash!

tmpdir=`mktemp -d`
conffile=${tmpdir}/nbd.conf
pidfile=${tmpdir}/nbd.pid
tmpnam=${tmpdir}/nbd.dd
mydir=$(dirname "`readlink -f $0`")

ulimit -c unlimited

# Create a one-meg device
dd if=/dev/zero of=$tmpnam bs=1024 count=4096 >/dev/null 2>&1

echo $1

case $1 in
	*/cmd)
		# Test with export specified on command line
		./nbd-server -C /dev/null -p ${pidfile} 11111 $tmpnam &
		# -p only works if nbd-server wasn't compiled with -DNOFORK or
		# -DNODAEMON, which I sometimes do for testing and debugging.
		PID=$!
		sleep 1
		./nbd-tester-client 127.0.0.1 11111
		retval=$?
	;;
	*/cfgsize)
		# Test oversized requests
		./nbd-server -C /dev/null -p ${pidfile} 11112 $tmpnam &
		# -p only works if nbd-server wasn't compiled with -DNOFORK or
		# -DNODAEMON, which I sometimes do for testing and debugging.
		PID=$!
		sleep 1
		./nbd-tester-client 127.0.0.1 11112 -o
		retval=$?
	;;
	*/cfg1)
		# Test with export specified in config file
		cat > ${conffile} <<EOF
[generic]
	oldstyle = true
	port = 10809
[export]
	exportname = $tmpnam
	port = 11113
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client 127.0.0.1 11113
		retval=$?
	;;
	*/cfgmulti)
		# Test with multiple exports specified in config file, and
		# testing more options too
		cat >${conffile} <<EOF
[generic]
	oldstyle = true
	port = 10810
[export1]
	exportname = $tmpnam
	port = 11114
	copyonwrite = true
	listenaddr = 127.0.0.1
[export2]
	exportname = $tmpnam
	port = 11115
	readonly = true
	listenaddr = 127.0.0.1
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost 11114
		retval=$?
		if [ $retval -ne 0 ]
		then
			if [ -f ${pidfile} ]
			then
				kill `cat ${pidfile}`
			else
				kill $PID
			fi
			if [ -z "$2" ]
			then
				rm -rf $tmpdir
			fi
			exit $retval
		fi
		./nbd-tester-client localhost 11115
		retval=$?
	;;
	*/cfgnew)
		# Test new-style exports
		cat >${conffile} <<EOF
[generic]
	port = 10811
[export1]
	exportname = $tmpnam
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost -N export1 10811
		retval=$?
	;;
	*/write)
		# Test writing
		cat >${conffile} <<EOF
[generic]
	port = 10812
[export1]
	exportname = $tmpnam
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost -N export1 10812 -w
		retval=$?
	;;
	*/flush)
		# Test writes with flush
		cat >${conffile} <<EOF
[generic]
	port = 10813
[export1]
	exportname = $tmpnam
	flush = true
	fua = true
	rotational = true
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost -N export1 10813 -w -f
		retval=$?
	;;
	*/integrity)
		# Integrity test
		cat >${conffile} <<EOF
[generic]
	port = 10814
[export1]
	exportname = $tmpnam
	flush = true
	fua = true
	rotational = true
	filesize = 52428800
	temporary = true
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost -N export1 10814 -i -t ${mydir}/integrity-test.tr
		retval=$?
	;;
	*/integrityhuge)
		# Integrity test
		cat >${conffile} <<EOF
[generic]
	port = 10815
[export1]
	exportname = $tmpnam
	flush = true
	fua = true
	rotational = true
	filesize = 52428800
	temporary = true
EOF
		./nbd-server -C ${conffile} -p ${pidfile} &
		PID=$!
		sleep 1
		./nbd-tester-client localhost -N export1 10815 -i -t ${mydir}/integrityhuge-test.tr
		retval=$?
	;;
	*)
		echo "E: unknown test $1"
		exit 1
	;;
esac
if [ -f ${pidfile} ]
then
	kill `cat ${pidfile}`
else
	kill $PID
fi
if [ -z "$2" ]
then
	rm -rf $tmpdir
fi

if [ $retval -ne 0 ]
then
	exit $retval
fi
